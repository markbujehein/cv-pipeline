name: Build CV PDFs

on:
  push:
    branches: [main]
    paths:
      - 'data/**'                  # YAML data files
      - 'templates/**'             # Jinja2 templates
      - 'scripts/generate.py'      # Generation script
      - 'scripts/test_data_completeness.py' # Test script
      - '.github/workflows/cv-build.yml'
  workflow_dispatch:               # Manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/xu-cheng/texlive-debian:latest
    strategy:
      matrix:
        variant:
          - academic-researcher
          - industrial-scientist
      fail-fast: false             # From Phase 1 feedback

    steps:
      - uses: actions/checkout@v4

      # Install Python and tools in container
      - name: Install Python and dependencies
        run: |
          apt-get update
          apt-get install -y python3 python3-pip poppler-utils
          pip3 install Jinja2 PyYAML --break-system-packages

      # Generate .tex from YAML
      - name: Generate LaTeX from YAML
        run: |
          mkdir -p output/generated
          python3 scripts/generate.py \
            --variant ${{ matrix.variant }} \
            --data-dir data/ \
            --output output/generated/${{ matrix.variant }}.tex

      # Copy LaTeX class files to output directory
      - name: Copy LaTeX class files
        run: |
          cp templates/altacv-class/*.cls output/generated/
          cp templates/altacv-class/*.cfg output/generated/

      # Compile LaTeX (container has full TeXLive)
      - name: Compile LaTeX
        run: |
          cd output/generated
          pdflatex -interaction=nonstopmode -halt-on-error ${{ matrix.variant }}.tex

      # Run data completeness tests (for this variant only)
      - name: Test data completeness
        run: |
          python3 scripts/test_data_completeness.py --variant ${{ matrix.variant }}

      # Upload PDF artifact
      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: cv-${{ matrix.variant }}
          path: output/generated/${{ matrix.variant }}.pdf
          retention-days: 90

  # NEW: Create GitHub Release with all CV PDFs
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install PyYAML

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: cv-artifacts

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Generate ATS-friendly versions
        run: |
          mkdir -p cv-artifacts/cv-academic-researcher
          mkdir -p cv-artifacts/cv-industrial-scientist
          python3 scripts/generate_ats.py --variant academic-researcher --data-dir data/ --output cv-artifacts/cv-academic-researcher/academic-researcher.txt
          python3 scripts/generate_ats.py --variant industrial-scientist --data-dir data/ --output cv-artifacts/cv-industrial-scientist/industrial-scientist.txt

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: cv-${{ steps.date.outputs.date }}
          name: CV Build ${{ steps.date.outputs.date }}
          body: |
            Automated CV build from commit ${{ github.sha }}

            Generated PDFs:
            - Academic Researcher CV (PhD Target)
            - Industrial Scientist CV (Job Target)
            Generated ATS-friendly TXT:
            - Academic Researcher CV (PhD Target)
            - Industrial Scientist CV (Job Target)
          files: |
            cv-artifacts/cv-academic-researcher/*.pdf
            cv-artifacts/cv-industrial-scientist/*.pdf
            cv-artifacts/cv-academic-researcher/*.txt
            cv-artifacts/cv-industrial-scientist/*.txt
          draft: false
          prerelease: false
